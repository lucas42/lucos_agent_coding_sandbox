# Lima VM configuration for the lucOS agent coding sandbox.
#
# Purpose: An isolated environment for running Claude Code with access to
# lucas42 GitHub repositories, but no access to the host machine or its
# credentials. The VM is persistent (not ephemeral) so work survives reboots.
#
# Key design decisions:
# - No host directory mounts: isolation from the host is the entire point.
#   Claude cannot reach host credentials, SSH keys, or any local data.
# - SSH agent forwarding disabled: Claude must use its own dedicated key.
# - vmType vz: best performance on Apple Silicon (macOS 13.5+).
# - Ubuntu 24.04 LTS: stable, well-supported, long EOL (April 2029).
# - setup-repos.sh is written using mode:data provision to avoid YAML/heredoc
#   nesting issues that arise when embedding shell scripts with heredocs.
#
# To create the VM:
#   brew install lima
#   limactl start --name lucos-coding-sandbox ~/sandboxes/lucos_agent_coding_sandbox/lima.yaml
#
# After the VM is running, complete setup:
#   limactl shell lucos-coding-sandbox
#   ~/setup-repos.sh

minimumLimaVersion: "2.0.0"

vmType: vz

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

cpus: 4
memory: "8GiB"
disk: "100GiB"

# No host mounts — isolation is the entire point of this VM.
# Claude Code runs inside the VM with no path to the host filesystem.
mounts: []

networks:
  - vzNAT: true

# SSH agent forwarding deliberately disabled.
# Claude inside the VM must use its own dedicated SSH key, not the host's.
ssh:
  forwardAgent: false

containerd:
  system: false
  user: false

provision:
  # -------------------------------------------------------------------------
  # System-level: install required packages
  # -------------------------------------------------------------------------
  - mode: system
    script: |
      #!/bin/bash
      set -euo pipefail
      export DEBIAN_FRONTEND=noninteractive

      apt-get update -q
      apt-get install -y -q \
        git \
        curl \
        wget \
        unzip \
        build-essential \
        openssh-client \
        ca-certificates \
        gnupg \
        jq \
        python3 \
        python3-pip \
        python3-venv

      # Install Node.js 22 LTS via NodeSource
      if ! command -v node &>/dev/null; then
        curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
        apt-get install -y nodejs
      fi

      # Install GitHub CLI
      if ! command -v gh &>/dev/null; then
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
          | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
          | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        apt-get update -q
        apt-get install -y gh
      fi

      # Install Claude Code system-wide via npm.
      # Must run as root (mode: system) because npm's global prefix is /usr,
      # and the Lima user does not have write permission to /usr/lib/node_modules.
      # Running npm install -g as the unprivileged user silently fails with EACCES.
      if ! command -v claude &>/dev/null; then
        npm install -g @anthropic-ai/claude-code
      fi

      # Install Go from the official tarball.
      # Ubuntu 24.04's apt package is Go 1.22, but lucos projects require >= 1.23
      # (lucos_creds uses golang:1.26). We install from the upstream tarball to
      # get a current, reproducible version. Architecture is detected at runtime
      # so this script works on both x86_64 (amd64) and aarch64 (arm64) VMs.
      # dpkg --print-architecture returns 'amd64' or 'arm64', matching Go's naming.
      GO_VERSION="1.26.0"
      if [ ! -d /usr/local/go ] || ! /usr/local/go/bin/go version 2>/dev/null | grep -q "go${GO_VERSION}"; then
        GOARCH=$(dpkg --print-architecture)
        curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-${GOARCH}.tar.gz" -o /tmp/go.tar.gz
        rm -rf /usr/local/go
        tar -C /usr/local -xzf /tmp/go.tar.gz
        rm /tmp/go.tar.gz
        echo 'export PATH=$PATH:/usr/local/go/bin' > /etc/profile.d/go.sh
        chmod +x /etc/profile.d/go.sh
      fi

      # Install Docker Engine + Docker Compose v2 (CLI plugin) via official apt repo.
      # We use the Docker-maintained repository rather than Ubuntu's docker.io package,
      # which is often significantly behind upstream and doesn't include compose v2.
      # compose v2 is the 'docker compose' CLI plugin (not the standalone docker-compose).
      if ! command -v docker &>/dev/null; then
        install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
          | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
          | tee /etc/apt/sources.list.d/docker.list > /dev/null
        apt-get update -q
        apt-get install -y -q \
          docker-ce \
          docker-ce-cli \
          containerd.io \
          docker-buildx-plugin \
          docker-compose-plugin
        systemctl enable docker
      fi

      # Add the VM user to the docker group so docker commands work without sudo.
      # Lima exposes the primary user as {{.User}}; we use the shell variable directly.
      LIMA_USER=$(id -nu 1000 2>/dev/null || echo "")
      if [ -n "$LIMA_USER" ] && ! id -nG "$LIMA_USER" | grep -qw docker; then
        usermod -aG docker "$LIMA_USER"
      fi

  # -------------------------------------------------------------------------
  # Deploy setup-repos.sh to the user's home directory.
  # Lima embeds the file content at instance creation time, so the host file
  # does not need to be accessible after the VM is running.
  # -------------------------------------------------------------------------
  - mode: data
    path: "{{.Home}}/setup-repos.sh"
    file: setup-repos.sh
    owner: "{{.User}}"
    permissions: "0755"

  # -------------------------------------------------------------------------
  # User-level: configure git identity and defaults
  # -------------------------------------------------------------------------
  - mode: user
    script: |
      #!/bin/bash
      set -euo pipefail

      # Git identity for lucos-agent[bot]
      # The noreply email must use the bot's GitHub *user* ID (263775988), NOT
      # the App ID (2943201). These are different values. GitHub links commits
      # to bot avatars via the user ID. Using the App ID produces a grey ghost.
      # User ID confirmed via: GET /users/lucos-agent%5Bbot%5D → .id
      git config --global user.name "lucos-agent[bot]"
      git config --global user.email "263775988+lucos-agent[bot]@users.noreply.github.com"

      # Use SSH for all GitHub operations (HTTPS won't work without tokens)
      git config --global url."git@github.com:".insteadOf "https://github.com/"

      # Sensible git defaults
      git config --global init.defaultBranch main
      git config --global pull.rebase false

      # Create sandboxes directory for repository checkouts
      mkdir -p "$HOME/sandboxes"

      echo "Provision complete."
      echo "Run ~/setup-repos.sh to generate your SSH key and clone all repositories."
