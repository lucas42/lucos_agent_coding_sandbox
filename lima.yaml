# Lima VM configuration for the lucOS agent coding sandbox.
#
# Purpose: An isolated environment for running Claude Code with access to
# lucas42 GitHub repositories, but no access to the host machine or its
# credentials. The VM is persistent (not ephemeral) so work survives reboots.
#
# Key design decisions:
# - No host directory mounts: isolation from the host is the entire point.
#   Claude cannot reach host credentials, SSH keys, or any local data.
# - SSH agent forwarding disabled: Claude must use its own dedicated key.
# - vmType vz: best performance on Apple Silicon (macOS 13.5+).
# - Ubuntu 24.04 LTS: stable, well-supported, long EOL (April 2029).
# - setup-repos.sh is written using mode:data provision to avoid YAML/heredoc
#   nesting issues that arise when embedding shell scripts with heredocs.
#
# To create the VM:
#   brew install lima
#   limactl start --name lucos-coding-sandbox ~/sandboxes/lucos_agent_coding_sandbox/lima.yaml
#
# After the VM is running, complete setup:
#   limactl shell lucos-coding-sandbox
#   ~/setup-repos.sh

minimumLimaVersion: "2.0.0"

vmType: vz

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

cpus: 4
memory: "8GiB"
disk: "100GiB"

# No host mounts — isolation is the entire point of this VM.
# Claude Code runs inside the VM with no path to the host filesystem.
mounts: []

networks:
  - vzNAT: true

# SSH agent forwarding deliberately disabled.
# Claude inside the VM must use its own dedicated SSH key, not the host's.
ssh:
  forwardAgent: false

containerd:
  system: false
  user: false

provision:
  # -------------------------------------------------------------------------
  # System-level: install required packages
  # -------------------------------------------------------------------------
  - mode: system
    script: |
      #!/bin/bash
      set -euo pipefail
      export DEBIAN_FRONTEND=noninteractive

      apt-get update -q
      apt-get install -y -q \
        git \
        curl \
        wget \
        unzip \
        build-essential \
        openssh-client \
        ca-certificates \
        gnupg \
        jq \
        python3 \
        python3-pip \
        python3-venv

      # Install Node.js 22 LTS via NodeSource
      if ! command -v node &>/dev/null; then
        curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
        apt-get install -y nodejs
      fi

      # Install GitHub CLI
      if ! command -v gh &>/dev/null; then
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
          | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
          | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        apt-get update -q
        apt-get install -y gh
      fi

  # -------------------------------------------------------------------------
  # Deploy setup-repos.sh to the user's home directory.
  # Lima embeds the file content at instance creation time, so the host file
  # does not need to be accessible after the VM is running.
  # -------------------------------------------------------------------------
  - mode: data
    path: "{{.Home}}/setup-repos.sh"
    file: setup-repos.sh
    owner: "{{.User}}"
    permissions: "0755"

  # -------------------------------------------------------------------------
  # User-level: configure git and install Claude Code
  # -------------------------------------------------------------------------
  - mode: user
    script: |
      #!/bin/bash
      set -euo pipefail

      # Install Claude Code globally via npm
      if ! command -v claude &>/dev/null; then
        npm install -g @anthropic-ai/claude-code
      fi

      # Git identity for lucos-agent[bot]
      # App ID 2943201 — noreply email uses the GitHub App bot format.
      # Commits authored by Claude inside this VM appear as the lucos-agent
      # bot rather than as a real person.
      git config --global user.name "lucos-agent[bot]"
      git config --global user.email "2943201+lucos-agent[bot]@users.noreply.github.com"

      # Use SSH for all GitHub operations (HTTPS won't work without tokens)
      git config --global url."git@github.com:".insteadOf "https://github.com/"

      # Sensible git defaults
      git config --global init.defaultBranch main
      git config --global pull.rebase false

      # Create sandboxes directory for repository checkouts
      mkdir -p "$HOME/sandboxes"

      echo "Provision complete."
      echo "Run ~/setup-repos.sh to generate your SSH key and clone all repositories."
